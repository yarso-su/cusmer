---
import Platform from '@/layouts/Platform.astro'
import Breadcrumb from '@/components/shared/Breadcrumb.astro'
import Plus from '@lucide/astro/icons/plus'
import { validateCookies } from '@/lib/server'
import { BadResponseError } from '@/lib/errors'
import { ORDER_STATUSES, THREAD_TYPES_KEYS } from '@/lib/constants'

export const prerender = false
if (!validateCookies(Astro.cookies))
  return Astro.redirect('/account/login', 307)

type TOrder = { id: number; name: string; tag: string; status: number }
let orders: Array<TOrder> = []

try {
  const res = await fetch(
    `${import.meta.env.API_URL}/users/me/orders?limit=10`,
    {
      headers: {
        Cookie: Astro.request.headers.get('cookie') || ''
      }
    }
  )

  if (!res.ok) throw new BadResponseError(res)

  const newCookies = res.headers.get('Set-Cookie')
  if (newCookies) {
    Astro.response.headers.set('Set-Cookie', newCookies)
  }

  const data = await res.json()
  orders = data.orders
} catch (error) {
  console.error(error)
  return Astro.redirect('/error', 307)
}
---

<Platform server>
  <div class="grid grid-rows-[auto_1fr] gap-2 h-full">
    <div>
      <Breadcrumb
        items={[
          { title: 'Plataforma', href: '/platform' },
          { title: 'Servicios', href: '/' }
        ]}
      />
      <div class="flex justify-between items-end">
        <h1
          class="scroll-m-20 text-left text-2xl lg:text-3xl font-extrabold tracking-tight text-balance"
        >
          Servicios
        </h1>
        <a
          href={`/platform/new-thread?type=${THREAD_TYPES_KEYS.NEW_INITIATIVE}`}
          class="hover:underline underline-offset-2 inline-flex gap-1 items-center"
        >
          <Plus class="size-4 text-contrast" />
          <p>Nueva iniciativa</p>
        </a>
      </div>
    </div>
    <section
      class="bg-csecondary cborder min-h-full h-full max-h-full overflow-y-auto"
    >
      {
        orders.length === 0 ? (
          <div class="w-full h-full flex items-center justify-center">
            <p class="opacity-60 dark:opacity-40">
              No hay servicios que mostrar
            </p>
          </div>
        ) : (
          <ul class="grid grid-cols-1 max-h-full overflow-y-auto">
            {orders.map(order => (
              <li>
                <a
                  class="cborder-b grid grid-cols-[1fr_1fr_auto] p-2 pressable-hover"
                  href={`/platform/services/${order.id}`}
                >
                  <p class="truncate">{order.name}</p>
                  <p class="cborder-l pl-2 truncate">{order.tag}</p>
                  <div class="px-2">
                    <p class="cborder-l pl-2">{ORDER_STATUSES[order.status]}</p>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        )
      }
    </section>
  </div>
</Platform>
